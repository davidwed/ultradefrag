<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>Chapter 11. Reporting bugs</title>
  <link rel="stylesheet" href="kde-default.css" type="text/css" />
  <link rel="stylesheet" href="udefrag.css" type="text/css" />
  <meta name="description" content="Ultra Defragmenter is a powerful Open Source defragmentation tool for Windows NT." />
  <meta name="keywords" content="UltraDefrag, Ultra Defragmenter, defragmentation, Open Source disk defragmenter, defragger, boot time defragmentation, boot time defragger, handbook, user manual, reporting bugs, bug tracker" />
  <link rel="start" href="index.html" title="Ultra Defragmenter Handbook" />
  <link rel="prev" href="faq.html" title="Chapter 11. Frequently Asked Questions" />
  <link rel="next" href="credits.html" title="Chapter 13. Credits and License" />
</head>

<body bgcolor="white" text="black" alink="#0000ff" link="#0000ff" vlink="#840084">

<div style="background-image: url(top-middle.png); width: 100%; height: 131px;">
	<div style="position: absolute; right: 0px;">
		<img src="top-right-konqueror.png" style="margin: 0px;" alt="" />
	</div>

	<div style="position: absolute; top: 25px; right: 100px; text-align: right; font-size: xx-large; font-weight: bold; text-shadow: #fff 0px 0px 5px; color: #444;">
	Reporting bugs</div>
</div>

<div style="margin-top: 20px; background-color: white; color: black; margin-left: 20px; margin-right: 20px;">
	<div style="position: absolute; left: 20px;"><a accesskey="p" href="faq.html">Prev</a></div>

	<div style="position: absolute; right: 20px;"><a accesskey="n" href="credits.html">Next</a></div>

	<div class="navCenter">&nbsp;</div>
</div>

<div class="chapter" lang="en">
	<div class="titlepage">
		<div><div>
				<h2 class="title">Chapter 12. Reporting bugs</h2>
		</div></div>
	</div>

	<div class="toc">
		<p><b>Table of Contents</b></p>
		<dl>
			<dt><span class="sect1"><a href="reporting_bugs.html#intro">Introduction</a></span></dt>
			<dt><span class="sect1"><a href="reporting_bugs.html#driver">Kernel mode driver debugging</a></span></dt>
			<dt><span class="sect1"><a href="reporting_bugs.html#user_mode_driver">User mode driver debugging</a></span></dt>
			<dt><span class="sect1"><a href="reporting_bugs.html#gui">Which info must contain a report about GUI bug?</a></span></dt>
		</dl>
	</div>

	<div class="sect1" lang="en">
		<div class="titlepage">
			<div><div>
				<h2 class="title" style="clear: both"><a name="intro"></a>
				Introduction</h2>
			</div></div>
		</div>
		<p>While the author of <span class="application">UltraDefrag</span> Driver has taken great pains to ensure that
		<span class="application">UltraDefrag</span> operates properly, no software is perfect. As such bugs are
		inevitable. The author accepts bug reports and will attempt to fix issues that
		are brought to his attention. In order to facilitate this the author has built
		logging mechanisms into UltraDefrag. This document describes how to get these
		logs and attach them to your bug report.</p>
		<p>Please report all problems and bugs via the 
		<a href="http://sourceforge.net/tracker/?atid=969870&group_id=199532&func=browse">bug tracker</a>.
		Don't forget to register on <a href="http://sourceforge.net">sourceforge.net</a> before. 
		As an alternative you can send your report directly to the authors by email.</p>
	</div>

	<div class="sect1" lang="en">
		<div class="titlepage">
			<div><div>
				<h2 class="title" style="clear: both"><a name="driver"></a>
				Kernel mode driver debugging</h2>
			</div></div>
		</div>
		<h4>Which types of kernel mode driver bugs can I encounter?</h4>
		<p>There are two possible types of kernel mode driver bugs:
		<ul type="disc">
		<li>Something goes wrong, but Windows is still working.</li>
		<li>Windows dies and shows well known Blue Screen Of Death (BSOD).</li>
		</ul>
		In accordance with them there are two debugging techniques discussed below.
		</p>
		<p><span style="color:darkred"><b>NOTE: </b>Ensure that your hardware is working properly! 
		Faulty RAM or overclocked CPU may be a cause of the Blue Screen! 
		Try one of the many free programs available for testing hardware (e.g. 
		<a href="http://www.memtest86.org/">Memtest86+</a>).
		</p>
		<h4>1. Algorithmic errors debugging</h4>
		<p>Algorithmic errors usually expresses themselves in file moving failures and other 
		lightweight mistakes during the defragmentation process.</p>
		<h5>Overview</h5>
		<p>Let us assume that something goes wrong in defragmentation process, but Windows 
		still works. Par example, you have noticed that some files are still fragmented after a job 
		completion though they were not excluded by filters. How to understand what happens?</p>
		<p>The best way to do so is running DbgPrint logger tool at the same time when you are 
		defragmenting volume. This tool will collect debugging messages from our driver and will display 
		them on the screen.</p>
		<p>There are two popular DbgPrint loggers available. Both have freeware status, you may download 
		them for free:
		<ul type="disc">
		<li><a href="http://technet.microsoft.com/en-us/sysinternals/bb896647.aspx">DbgView program by Mark Russinovich</a></li>
		<li><a href="http://alter.org.ua/en/soft/win/dbgdump/">DbgPrint Logger by Alexander Telyatnikov</a></li>
		</ul>
		</p>
		<p style="color: darkred;">Note that you cannot use both loggers at the same time, otherwise debugging 
		information may be partially losed.</p>
		<h5>How can I use DbgView program?</h5>
		<center><img src="debugview.png" alt="DbgView main window sreenshot" /></center>
		<p>First of all, if you are using Windows NT 4.0, you must download one of the earlier versions of 
		DbgView that supports it. You may download the 4.05 version 
		<a href="http://doc.sch130.nsc.ru/www.sysinternals.com/ntw2k/freeware/debugview.shtml">here</a>.</p>
		<p>DbgView is a nice graphical application which has very easy to use design. Run it and select 
		<span class="guimenuitem">Capture Kernel</span> item in <span class="guimenuitem">Capture</span> menu. 
		If you wish to debug the <span class="application">UltraDefrag</span> boot time (native) interface, check also 
		<span class="guimenuitem">Log Boot</span> menu item. Now you can see all debugging information in application's 
		window. Yes, it is empty at this moment, because <span class="application">UltraDefrag</span> is still not running. 
		To reclaim this mistake launch it and see something like this:</p>
<pre class="screen"><strong class="userinput"><code>=Ultradfg= UltraDefrag v3.2.0
=Ultradfg= NT 5.1 free.
=Ultradfg= Kernel found: \WINDOWS\system32\ntoskrnl.exe
=Ultradfg= Kernel address: 804D4000
=Ultradfg= ExFreePoolWithTag address: 8053C789
=Ultradfg= KeDeregisterBugCheckReasonCallback address: 80525BD3
=Ultradfg= KeRegisterBugCheckReasonCallback address: 80506077
=Ultradfg= MmMapLockedPagesSpecifyCache address: 804ED02A
=Ultradfg= KeQueryInterruptTime address: 804EE0EA
=Ultradfg= Main FDO 81D055A0, DevExt=81D05658
=Ultradfg= Map  FDO 81C1B8C8, DevExt=81C1B980
=Ultradfg= Stat FDO 81C29250, DevExt=81C29308
=Ultradfg= DriverEntry successfully completed
-Ultradfg- CreateFile request for main device
-Ultradfg- IOCTL_SET_USER_MODE_BUFFER
-Ultradfg- Address = 0047E060
-Ultradfg- IOCTL_SET_CLUSTER_MAP_SIZE
-Ultradfg- Map size = 910
-Ultradfg- Cluster map will be allocated from NonPagedPool.
-Ultradfg- IOCTL_SET_DBGPRINT_LEVEL
-Ultradfg- dbg_level=2
-Ultradfg- IOCTL_SET_SIZELIMIT
-Ultradfg- Sizelimit = 26214400
-Ultradfg- IOCTL_SET_REPORT_STATE
-Ultradfg- Disable reports: NO
-Ultradfg- IOCTL_SET_XXX_FILTER
-Ultradfg- Include: win
-Ultradfg- Filter strings:
-Ultradfg-  + win
-Ultradfg- IOCTL_SET_XXX_FILTER
-Ultradfg- Exclude: config
-Ultradfg- Filter strings:
-Ultradfg-  - config
</code></strong></pre>
		<p>As you can see, our driver successfully retrieved the Windows version and 
		kernel entry points for some functions missing on NT 4.0. Also defragmentation options 
		were successfully set.</p>
		<p>If you will click <span class="guimenuitem">Analyse</span> button in 
		<span class="application">UltraDefrag</span> GUI you will see debugging information related to 
		the volume analysis process. In case of running disk defragmentation job you will see detailed 
		information about files moving including messages about possible moving errors.</p>
		<p>When you close the Ultra Defragmenter you will see something like this:</p>
<pre class="screen"><strong class="userinput"><code>-Ultradfg- STOP request
-Ultradfg- CloseHandle request for main device
-Ultradfg- In Unload Routine
-Ultradfg- Symbolic links were deleted
-Ultradfg- Deleted device 81B44500
-Ultradfg- Deleted device 81C29250
-Ultradfg- Deleted device 81C1B8C8
-Ultradfg- Deleted device 81D055A0
</code></strong></pre>
		<p>Here our driver reports you that it was successfully unloaded.</p>
		<p>As you can see, debugging process is very easy. Enjoy it and don't forget to attach 
		important parts of debugging log when you are sending a bug report.</p>
		
		<h5>How can I use DbgPrint Logger program?</h5>
<!--
<center>
<pre width="70pt" style="border: 2px solid; background-color: black; font-size: 11pt;">
<div align="center" style="background-color: blue; color: white">Command prompt</div><div align="left" style="color: white">
I:\DbgPrnHk_v7g_all>DbgPrintLog.exe
DbgPrintLog v0.7g (c) by Alter
Home site http://www.alter.org.ua
Commands:
        'Esc'   - exit
        'N'     - start new log
        'F'     - flush log buffer
        'H'     - display this help message
Mode switchers (toggle on'off):
        'Space' - pause                    '?'  - get current options
        'S'     - synchronous mode         'C'  - copy log to stdout
        'K'     - capture kernel messages  'U'  - capture user-mode
        'I'     - check IRQL               'P'  - pass down
        'O'     - stop on overflow         'A'  - aggregate
Writing log to DbgPrint4.log</div>
</pre>
</center>
-->
		<center><img src="dbgprint_logger.jpg" alt="DbgPrint Logger screenshot" /></center>
		<p>Though DbgPrint Logger has no graphical interface it is still very easy to use. Click on 
		<span class="code">DbgPrintLog.exe</span> icon to run it. To close debugging session press 
		<span class="code">Esc</span> button. After that you will find debugging messages in 
		<span class="code">DbgPrintXX.log</span> file. Unfortunately text saved there has UNIX format. 
		You can read them using standard Wordpad application included in all versions of Windows.</p>
		<p>A little bit more hacking is needed for boot time logging. Save the following contents in 
		<span class="code">udefrag-boot-logging.cmd</span> file:
<pre class="screen"><strong class="userinput"><code>DbgPrintLog.exe --full -T DTN -wd c:\ --drv:inst 1 --svc:inst 
                A --drv:opt DoNotPassMessagesDown 1 udefrag.log
</code></strong></pre>
		</p>
		<p style="color:darkred">Note: write this instruction on a single line, without line breaks!</p>
		<p>Click <span class="code">udefrag-boot-logging.cmd</span> icon. Now DbgPrint Logger is ready 
		to collect debugging information during Windows boot process. You will fing log files in root directory 
		of volume C: as specified in <span class="code">DbgPrintLog.exe</span> command options.</p>
		<p>DbgPrint Logger can be executed on a large number versions of Windows, enjoy it and don't forget to attach 
		important parts of debugging log when you are sending a bug report.</p>
		
		<h5>Additional software useful for debugging purposes</h5>
		
		<p>Download and install the following software to collect an additional information about 
		running UltraDefrag components:
		<ul type="disc">
		<li><a href="http://www.osr.com">PoolTag</a>. Note that it is included in Windows DDK. 
		Using this tool you can watch driver memory allocation. The UltraDefrag driver tag is 'ULTR'.</li>
		<li><a href="http://www.freewebs.com/four-f/index.htm">StatusToError</a> tool included in KmdKit. 
		Input the NTSTATUS code
		given by the UltraDefrag gui, console or native app and it will give you
		the localized error description. A simple but very useful tool, especially 
		for boot time defragmentation errors, where it is impossible for the
		program to do localization lookups.</li>
		<li><a href="http://www.sysinternals.com">Sysinternals</a> tools, including 
		<a href="http://technet.microsoft.com/en-us/sysinternals/bb896657.aspx">WinObj</a> 
		(Allows you to see when UltraDefrag opens its driver, creates some events etc), 
		<a href="http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx">Process Monitor</a> 
		and <a href="http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx">Process Explorer</a>.</li>
		</ul>
		</p>
		
		<h4>2. Fatal errors debugging</h4>
		<p>Fatal driver errors usually crashes your system.</p>
		<h5>Overview</h5>
		<p>When Windows dies, all running programs becomes died too. Therefore you cannot use DbgPrint logger 
		at this time. Hopefully Windows itself contains one good mechanism that helps us to debug such kind of 
		errors. Its name is Crash Memory Dump.</p>
		<p>If something in driver goes wrong and Windows decides that this wrong behavior can damage your system, 
		it stops any running processes and shows you BSOD screen with brief description of the encountered problem. 
		It is a very good practice to have always a small piece of paper and a pencil near your machine. When you are 
		encountering BSOD, write on paper numbers shown on your screen. To be able to attach these numbers to your 
		bug report.</p>
		<center><img src="bsod.png" alt="One screenshot of the Blue Screen Of Death" /></center>
		<p>Note that BSOD showing feature itself is disabled by default in Windows. You should enable them manually 
		by setting the following system registry value to 0x0 state:
<pre class="screen"><strong class="userinput"><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\CrashControl\AutoReboot
</code></strong></pre>
		</p>
		<p>What's about Crash Dump files? These files contain additional information about encountered problem. Therefore it 
		will be very appreciated if you will attach the Crash Dump file to your bug report. It will help us to fix driver bug 
		faster and easier.</p>
		<p>Crash Dump generation may be disabled in your version of Windows. Therefore check please is it enabled or not by opening 
		the following system dialog: <span class="guimenuitem">MyComputer > Properties > Advanced > Startup and Recovery Settings</span>.</p>
		
		<p>It is highly recommended to select <span class="guimenuitem">Kernel memory dump</span> option in 
		<span class="guimenuitem">Write debugging information</span> section of this dialog. Selecting kernel memory dump gives you 
		an ability to get much more detailed information about a possible driver's failure. Usually such kind of memory dump requires 
		few tens of megabytes of disk free space. If and only if you cannot provide such amount of disk space then select the 
		<span class="guimenuitem">Small memory dump</span> option.</p>

		<p>Note also: when you are selecting <span class="guimenuitem">Kernel Memory Dump</span> 
		or <span class="guimenuitem">Full Memory Dump</span> options, you will always have after a crash
		a Small Memory Dump generated too.</p>
		
		<p>The following set of screenshots illustrates crash dump tuning process.</p>
		<center>
			<img src="crash_control1.png" alt="" /><br /><br />
			<img src="crash_control2.png" alt="" /><br /><br />
			<img src="crash_control3.png" alt="" /><br />
		</center>
		
		<p>Small Memory Dump files can be found in <span class="code">WINDOWS\Minidump</span> directory. Kernel Memory Dump 
		usually contains in a single <span class="code">WINDOWS\MEMORY.DMP</span> file.</p>
		
		<p>After setting crash dump parameters you are ready for basic driver testing. The process is very easy:
		<ol>
		<li>Start DbgView program. If you have selected kernel memory dump before then DbgView will save debugging messages to it during the system crash.</li>
		<li>Try to reproduce BSOD.</li>
		<li>Push <span class="code">Reset</span> button on your PC to reboot after BSOD.</li>
		<li>Start DbgView program again. Select <span class="guimenuitem">File > Process Crash Dump...</span> menu item and select 
		the file containing kernel memory dump. DbgView will ask you for a name of file where it will save extracted debugging messages.
		Click OK button and attach saved data to your bug report.</li>
		</ol>
		</p>
		
		<p>So, if you have encountered the Blue Screen, don't forget to attach a Small Memory Dump file to your report. Or, at least, 
		attach please numbers shown on your screen. Sending debugging messages saved by DbgView program is very appreciated too.</p>

		<h5>Which tests can I additionally perform to speed up bug fixing?</h5>
		<p>There is one cool program shipped with all versions of Windows: Driver Verifier. Open the run box or command line and type 
		<span class="code">verifier.exe</span> to run it. As a result you will see its window. Select <span class="guimenuitem">Create standard 
		settings</span> item and click <span class="guimenuitem">Next</span> button. Choose <span class="guimenuitem">Select driver names 
		from a list</span> item and click <span class="guimenuitem">Next</span> again. Click <span class="guimenuitem">Add currently not loaded driver(s) 
		to the list...</span> button and select <span class="code">ultradfg.sys</span> driver. Click <span class="guimenuitem">Finish</span> button and 
		reboot your system. Now you are ready for advanced <span class="application">UltraDefrag</span> driver testing.</p>
		<p>Play with <span class="application">UltraDefrag</span> program trying to reproduce the Blue Screen. After arriving them send bug report 
		with a small memory dump (and DbgView log) attached. And don't forget to attach a notice that you have used Driver Verifier during your test. Good luck!</p>
		<p>The following set of screenshots illustrates a typical verifier's working session.</p>
		<center>
			<img src="verifier1.png" alt="" /><br /><br />
			<img src="verifier2.png" alt="" /><br /><br />
			<img src="verifier3.png" alt="" /><br /><br />
			<img src="verifier4.png" alt="" /><br /><br />
			<img src="verifier5.png" alt="" /><br /><br />
			<img src="verifier6.png" alt="" /><br /><br />
			<img src="verifier7.png" alt="" /><br />
		</center>
	</div>

	<div class="sect1" lang="en">
		<div class="titlepage">
			<div><div>
				<h2 class="title" style="clear: both"><a name="user_mode_driver"></a>
				User mode driver debugging</h2>
			</div></div>
		</div>
		<p>Use DbgView program or DbgPrint Logger as described above to understand better what happens when something 
		goes wrong in the defragmentation process. Just don't forget to check the <span class="guimenuitem">Capture Win32</span> 
		item in <span class="guimenuitem">Capture</span> menu of DbgView program before.</p>
		<p>Note also that unfortunately both described DbgPrint loggers cannot capture debugging output of the 
		user mode driver at boot time which makes its debugging much more complicated.</p>
		<p>Additionally keep in mind that user mode driver usually cannot cause BSOD. We know only a single 
		exception for this rule - when you are trying to analyze/defragment NTFS formatted volume under NT4.0 
		anything may happen.</p>
	</div>

	<div class="sect1" lang="en">
		<div class="titlepage">
			<div><div>
				<h2 class="title" style="clear: both"><a name="gui"></a>
				Which info must contain a report about GUI bug?</h2>
			</div></div>
		</div>
		<p>If you have any problems with GUI application, Configurator, Scheduler or web site appearance, attach screenshots please to your 
		bug report.</p>
	</div>
</div>

<div style="color: black; margin-top: 20px; margin-left: 20px; margin-right: 20px;">
	<div style="position: absolute; left: 20px;"><a accesskey="p" href="faq.html">Prev</a></div>

	<div style="position: absolute; right: 20px;"><a accesskey="n" href="credits.html">Next</a></div>

	<div align="center"><a accesskey="h" href="index.html">Home</a></div>
</div>

<div style="color: black; margin-left: 20px; margin-right: 20px;">
	<div class="navLeft">Frequently Asked Questions&nbsp;</div>

	<div class="navRight">&nbsp;Credits and License</div>

	<div class="navCenter"><a accesskey="u" href="index.html">Up</a></div>
</div>

<br />
<br />

<div class="bannerBottom" style="background-image: url(bottom-middle.png); width: 100%; height: 100px; bottom: 0px;">
	<div class="bannerBottomRight">
		<img src="bottom-right.png" style="margin: 0px;" alt="" />
	</div>
	<div class="bannerBottomLeft">
		<img src="bottom-left.png" style="margin: 0px;" alt="" />
	</div>
	<div class="bannerBottomLeft">
		<a href="http://ultradefrag.sourceforge.net/" style="position: absolute; left: 10px;">
		  <img src="udefrag124x31.gif" alt="ultradefrag.sourceforge.net" border="0" width="124" height="31" />
		</a>
		<a href="http://sourceforge.net/projects/ultradefrag" style="position: absolute; left: 134px;">
		  <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=199532&amp;type=11" alt="" border="0" height="30" width="120"  />
		</a>
	</div>
</div>

<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://apps.sourceforge.net/piwik/ultradefrag/" : "http://apps.sourceforge.net/piwik/ultradefrag/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
piwik_action_name = '';
piwik_idsite = 1;
piwik_url = pkBaseURL + "piwik.php";
piwik_log(piwik_action_name, piwik_idsite, piwik_url);
</script>
<object><noscript><p><img src="http://apps.sourceforge.net/piwik/ultradefrag/piwik.php?idsite=1" alt="piwik"/></p></noscript></object>
<!-- End Piwik Tag -->

</body>
</html>
