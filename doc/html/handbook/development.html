<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
	<title>Appendix A. Development</title>
	<link rel="stylesheet" href="kde-default.css" type="text/css" />
	<link rel="stylesheet" href="udefrag.css" type="text/css" />
	<meta name="description" content="Ultra Defragmenter is a powerful Open Source defragmentation tool for Windows NT." />
	<meta name="keywords" content="UltraDefrag, Ultra Defragmenter, defragmentation, Open Source disk defragmenter, defragger, boot time defragmentation, boot time defragger, handbook, user manual, development, compilation" />
	<link rel="start" href="index.html" title="Ultra Defragmenter Handbook" />
	<link rel="prev" href="credits.html" title="Chapter 12. Credits and License" />
	<link rel="next" href="design_notes.html" title="Design Notes" />
</head>

<body bgcolor="white" text="black" alink="#0000ff" link="#0000ff" vlink="#840084">

<div style="background-image: url(top-middle.png); width: 100%; height: 131px;">
	<div style="position: absolute; right: 0px;">
		<img src="top-right-konqueror.png" style="margin: 0px;" alt="" />
	</div>

	<div style="position: absolute; top: 25px; right: 100px; text-align: right; font-size: xx-large; font-weight: bold; text-shadow: #fff 0px 0px 5px; color: #444;">
	Development</div>
</div>

<div style="margin-top: 20px; background-color: white; color: black; margin-left: 20px; margin-right: 20px;">
	<div style="position: absolute; left: 20px;"><a accesskey="p" href="credits.html">Prev</a></div>

	<div style="position: absolute; right: 20px;"><a accesskey="n" href="design_notes.html">Next</a></div>

	<div class="navCenter">&nbsp;</div>
</div>

<div class="chapter" lang="en">
	<div class="titlepage">
		<div><div>
				<h2 class="title">Appendix A. Development</h2>
		</div></div>
	</div>

	<div class="toc">
		<p><b>Table of Contents</b></p>
		<dl>
			<dt><span class="sect1"><a href="development.html#compilation">Compilation</a></span></dt>
			<dt><span class="sect1"><a href="design_notes.html">Design notes</a></span></dt>
			<dt><span class="sect1"><a href="i18n.html">Translation</a></span></dt>
		</dl>
	</div>
	
	<div class="sect1" lang="en">
		<div class="titlepage">
			<div><div>
				<h2 class="title" style="clear: both"><a name="compilation"></a>
				Compilation</h2>
			</div></div>
		</div>
		<h4>1. Software requirements</h4>

		<h5>1.1 Compilation with Windows Server 2003 DDK</h5>

		<p>The best way to build UltraDefrag is to use the Windows Server 2003 Driver
		Development Kit (DDK). You can simply download it from one of the locations
		that can be found using any web search system (e.g. 
		<a href="http://www.google.com">Google</a>).</p>

		<p>The only disadvantage of this method is that the Windows DDK is a really 
		big package (about 230 Mb). However, if you have an internet connection with 
		a good download rate, its should not be a large problem.</p>

		<h5>1.2 Compilation with MinGW</h5>

		<p>Other interesting way to produce UltraDefrag package is to do so using MinGW.
		GNU C Compiler (GCC) has one important advantage over the Microsoft C
		compiler, it produces many useful warnings for code that is not completely
		within the C standard. I have removed hundreds of small bugs from UltraDefrag
		thanks to the warnings produced by GCC. The biggest disadvantage of gcc is that 
		it produces larger executables than the microsoft compiler, e.g. a driver
		produced by DDK may have 22.0 Kb size, but the same driver produced by GCC is
		only about 32.0 kb.</p>

		<p>You can either download MinGW from 
		<a href="http://www.mingw.org">mingw.org</a> or download	MinGW Developer Studio 
		from <a href="http://www.parinyasoft.com">parinyasoft.com</a> (about 25 Mb).</p>

		<p>Note that the MinGW build system can only build i386 binaries.</p>

		<p><b><font size="-1">VERY IMPORTANT NOTE:</font></b> If you build the dynamic libraries from the MinGW
		Developer Studio, the resulting *.a files are invalid. This is because I don't
		know how to specify linker options in Developer Studio's project file. Use
		makefiles instead:
<pre class="screen"><strong class="userinput"><code>mingw32-make Makefile.mingw</code></strong></pre>
		</p>

		<h5>1.3 Compilation with Microsoft Visual Studio 6.0</h5>

		<p>This is another method for building UltraDefrag. It does not require the
		DDK. You can use Microsoft C compiler included in MS Visual Studio version 6.0
		or later.</p>

		<p>To use this method you will need to obtain a copy of ReactOS source code
		from <a href="http://www.reactos.org">ReactOS website</a> for special header files 
		used to build the driver.</p>

		<p>You will also need to download the following files:
		<a href="http://www.masm32.com/board/index.php?topic=2124.new">ntdll.lib</a> and 
		<a href="http://www.freewebs.com/four-f/index.htm">ntoskrnl.lib + hal.lib</a> 
		(included in KmdKit package). 
		Put these files to lib subdirectory of your Visual Studio installation.</p>

		<p><b><font size="-1">VERY IMPORTANT NOTE:</font></b> The winnt.h file in visual studio 6.0 
		contains an incorrect definition of the NtCurrentTeb function. Therefore replace the
		following lines:

<pre class="screen"><code>#if defined(_M_ALPHA)
#define NtCurrentTeb() ((struct _TEB *)_rdteb())
#else
struct _TEB *
NtCurrentTeb(void);
#endif</code></pre>

with:

<pre class="screen"><code>#if defined(_M_ALPHA)
#define NtCurrentTeb() ((struct _TEB *)_rdteb())
#else
struct _TEB *
__stdcall NtCurrentTeb(void);
#endif</code></pre>
		</p>

		<p>Finally, edit ultradfg.dsp file (driver project file), and ensure that the
		reactos header paths are properly set.</p>

		<p>Note that currently only i386 binaries can be produced using this way.</p>


		<h5>1.4 Common tools</h5>

		<p>There are a few other tools that you should have installed on your PC to
		perform a full-featured build:</p>

		<ul>
		<li><a href="http://nsis.sourceforge.net">NSIS compiler</a> is used to produce installers.
		Currently I'm using NSIS v2.28.
		NOTE: In my nsisconf.nsh file (in NSIS root directory) I have 
		the following line:
<pre class="screen"><code>!packhdr temp.dat '"C:\WINDOWS\upx" -9 -q temp.dat'</code></pre>
		You may not include this instruction, because installer script contains 
		<span class="code">SetCompressor /SOLID lzma</span> 
		command that is much effective in our case.
		</li>

		<li><a href="http://upx.sf.net">Ultimate Packer for eXecutables (upx)</a> is used to
		reduce sizes of some binary modules. I'm using version 2.03w. Put the
		upx.exe file in one of the directories, specified in your PATH environment
		variable, p.a. in %windir%\system32.</li>

		<li><a href="http://www.7-zip.org">7-zip file archiver</a> is used to produce 
		the source code package.</li>

		<li>.NET framework v2.0.50727 or later is used to compile the 
		UltraDefrag Scheduler.NET application. <span style="color:darkred;">Since 3.2.0 version of 
		the program this component is optional, because Scheduler itself has been rewritten in C 
		language using Windows API. If you aren't C# developer, feel free to deinstall NET framework 
		from your system.</span></li>

		<li><a href="http://www.activestate.com">Perl</a> language package for Windows.
		Currently I'm using v5.8.6 to execute configure.pl script and to develop the Modern 
		UltraDefrag User Interface (that was created for extended gui configuration abilities).</li>

		<li><a href="http://www.doxygen.org">Doxygen</a> is used to produce a special kind of 
		documentation from project's source files. It contains descriptions 
		of functions and global variables dependencies and may be used e.g. for
		removing unnecessary data fields from program's internal structures.
		Also it is helpful for any other program code cleanup.
		So, if you are programmer, this tool is highly recommended for you.</li>

		<li><a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> is used to 
		build interface documentation, that you should use as main developer
		manual. You will find here all descriptions of functions exported by 
		UltraDefrag and ZenWINX (that is a part of the Ultra Defragmenter)
		libraries, important notes about undocumented windows functions usage
		and many other aspects of the Ultra Defragmenter development.
		To build a basic version of docs, simply type:

<pre class="screen"><strong class="userinput"><code>robodoc</code></strong></pre>

		To produce more detailed developer manual, type:

<pre class="screen"><strong class="userinput"><code>robodoc --internal</code></strong></pre>
		</li>

		<li><a href="http://www.etree.org/md5com.html">md5sum</a> tool is used to generate 
		file ultradefrag-x.y.z.MD5SUMS that	gives you an ability to check downloaded packages 
		integrity.</li>

		<li><a href="http://luabinaries.luaforge.net/">Lua</a> language binaries package is used 
		to execute some build scripts. Install it in some folder on your %PATH% and rename 
		lua5.1.exe to lua.exe.</li>
		
		</ul>

		<h5>1.5 Software recommended for debugging purposes</h5>

		<p>Because the actual work done by UltraDefrag is done by kernel mode driver,
		you can download the tools described below to troubleshoot bugs. Even if you
		are not programmer, these tools may be very useful for you:</p>

		<ul>
		<li>
			<p><a href="http://technet.microsoft.com/en-us/sysinternals/bb896647.aspx">DebugView</a>. 
			Its window will show you some interesting information given by driver engine: 
			number of clusters on your volumes, mft position and much more.</p>

			<p>Some other useful tools available from
			<a href="http://www.sysinternals.com">sysinternals</a> are:
				<ul>
				<li>WinObj: Allows you to see when UltraDefrag opens its driver, creates 
				some events etc.</li>
				<li>File Monitor</li>
				<li>Registry Monitor</li>
				</ul>
			</p>
		</li>

		<li><a href="http://www.osr.com">PoolTag</a>. Note that it is included in Windows DDK. 
		Using this tool you can watch driver memory allocation. The UltraDefrag driver tag is 'ULTR'.</li>

		<li><a href="http://www.freewebs.com/four-f/index.htm">StatusToError</a> tool included in KmdKit. 
		Input the NTSTATUS code
		given by the UltraDefrag gui, console or native app and it will give you
		the localized error description. A simple but very useful tool, especially 
		for boot time defragmentation errors, where it is impossible for the
		program to do localization lookups.</li>

		</ul>

		<h5>1.6 Especially for Mr. Random Newbe (Some notes for the beginners)</h5>

		<p>Many of described tools have small size, and you don't need high-speed
		internet connection to download their latest versions. Simply do it.</p>

		<p>If you will place tools executables in one of the directories, specified 
		in your PATH environment variable, the command execution will be very easy 
		process, because you can type commands without paths in the command prompt.</p>

		<h4>2. Building and installation</h4>

		<ol>
		<li>Download source archive and unpack it somewhere. <b><font size="-1">NOTE:</font></b> 
		Currently path must not contain spaces. 
		If you have some ideas how to fix that send your report to the authors, please.</li>
		<li>Configure build options by typing the following command:

<pre class="screen"><strong class="userinput"><code>perl configure.pl</code></strong></pre>

		<p>This tool has a graphical interface. Enter the paths to prerequisite
		libraries and other options. If you prefer to use MinGW, click the button
		<span class="guimenuitem">Apply patch to MinGW</span> to replace some libraries included in MinGW
		(libntdll.a and libntoskrnl.a) with more adequate versions. Old libraries
		will be saved in files with additional suffix '.orig'.</p>

		<p>Here is an example:</p>
		<center><img src="config.pl.png" /></center><br />
		</li>

		<li>To build UltraDefrag use the BUILD.CMD script:
<pre class="screen"><strong class="userinput"><code>build              - perform the build using default options
build --install    - run installer silently after the build
build [--use-winddk or --use-mingw or --use-msvc] [--install]
                   - specify your favorite compiler
build --clean      - perform full cleanup instead of the build
build --help       - show help message
</code></strong></pre>
		</li>

		<li>To build UltraDefrag Micro Edition package use the build-micro.cmd scipt.
		It has the same options that build.cmd has. After a successfull 
		compilation you will have ready to use binary packages, but the source 
		code archive will not be produced (to increase the compilation speed).
		To make an archive of sources run build.cmd script.</li>
		</ol>
	</div>
</div>

<div style="color: black; margin-top: 20px; margin-left: 20px; margin-right: 20px;">
	<div style="position: absolute; left: 20px;"><a accesskey="p" href="credits.html">Prev</a></div>

	<div style="position: absolute; right: 20px;"><a accesskey="n" href="design_notes.html">Next</a></div>

	<div align="center"><a accesskey="h" href="index.html">Home</a></div>
</div>

<div style="color: black; margin-left: 20px; margin-right: 20px;">
	<div class="navLeft">Credits and License&nbsp;</div>

	<div class="navRight">&nbsp;Design Notes</div>

	<div class="navCenter"><a accesskey="u" href="index.html">Up</a></div>
</div>

<br />
<br />

<div class="bannerBottom" style="background-image: url(bottom-middle.png); width: 100%; height: 100px; bottom: 0px;">
	<div class="bannerBottomRight">
		<img src="bottom-right.png" style="margin: 0px;" alt="" />
	</div>
	<div class="bannerBottomLeft">
		<img src="bottom-left.png" style="margin: 0px;" alt="" />
	</div>
	<div class="bannerBottomLeft">
		<a href="http://ultradefrag.sourceforge.net/" style="position: absolute; left: 10px;">
		  <img src="udefrag124x31.gif" alt="ultradefrag.sourceforge.net" border="0" width="124" height="31" />
		</a>
		<a href="http://sourceforge.net/projects/ultradefrag" style="position: absolute; left: 134px;">
		  <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=199532&amp;type=11" alt="" border="0" height="30" width="120"  />
		</a>
	</div>
</div>

<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://apps.sourceforge.net/piwik/ultradefrag/" : "http://apps.sourceforge.net/piwik/ultradefrag/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
piwik_action_name = '';
piwik_idsite = 1;
piwik_url = pkBaseURL + "piwik.php";
piwik_log(piwik_action_name, piwik_idsite, piwik_url);
</script>
<object><noscript><p><img src="http://apps.sourceforge.net/piwik/ultradefrag/piwik.php?idsite=1" alt="piwik"/></p></noscript></object>
<!-- End Piwik Tag -->

</body>
</html>
