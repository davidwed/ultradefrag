<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
	<title>Appendix A. Development</title>
	<link rel="stylesheet" href="kde-default.css" type="text/css" />
	<link rel="stylesheet" href="udefrag.css" type="text/css" />
	<meta name="description" content="Ultra Defragmenter is a powerful Open Source defragmentation tool for Windows NT." />
	<meta name="keywords" content="UltraDefrag, Ultra Defragmenter, defragmentation, Open Source disk defragmenter, defragger, boot time defragmentation, boot time defragger, handbook, user manual, development, compilation" />
	<link rel="start" href="index.html" title="Ultra Defragmenter Handbook" />
	<link rel="prev" href="credits.html" title="Chapter 13. Credits and License" />
	<link rel="next" href="design_notes.html" title="Design Notes" />
	<script type="text/javascript" src="handbook.js"></script>
</head>

<body bgcolor="white" text="black" alink="#0000ff" link="#0000ff" vlink="#840084">

<div style="background-image: url(top-middle.png); width: 100%; height: 131px;">
	<div style="position: absolute; right: 0px;">
		<img src="top-right-konqueror.png" style="margin: 0px;" alt="" />
	</div>

	<div style="position: absolute; top: 25px; right: 100px; text-align: right; font-size: xx-large; font-weight: bold; text-shadow: #fff 0px 0px 5px; color: #444;">
	Development</div>
</div>

<div style="margin-top: 20px; background-color: white; color: black; margin-left: 20px; margin-right: 20px;">
	<div style="position: absolute; left: 20px;"><a accesskey="p" href="credits.html">Prev</a></div>

	<div style="position: absolute; right: 20px;"><a accesskey="n" href="design_notes.html">Next</a></div>

	<div class="navCenter">&nbsp;</div>
</div>

<div class="chapter" lang="en">
	<div class="titlepage">
		<div><div>
				<h2 class="title">Appendix A. Development</h2>
		</div></div>
	</div>

	<div class="toc">
		<p><b>Table of Contents</b></p>
		<dl>
			<dt><span class="sect1"><a href="development.html#compilation">Compilation</a></span></dt>
			<dt><span class="sect1"><a href="design_notes.html">Design notes</a></span></dt>
			<dt><span class="sect1"><a href="i18n.html">Translation</a></span></dt>
		</dl>
	</div>
	
	<div class="sect1" lang="en">
		<div class="titlepage">
			<div><div>
				<h2 class="title" style="clear: both"><a name="compilation"></a>
				Compilation</h2>
			</div></div>
		</div>
		<h4>1. Software requirements</h4>
		
		<table border="0" width="300"><tbody>
		
		<tr><td>1. <a href="http://www.mingw.org/">GNU C Compiler</a></td>
		<td><font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/MinGWStudioFullSetup-2.05.exe">download</a>] 
		</font></td>
		</tr>
		
		<tr><td>2. <a href="http://nsis.sourceforge.net/">NSIS compiler</a></td>
		<td> <font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/nsis-2.28-setup.exe">download</a>] 
		</font></td>
		</tr>

		<tr><td>3. <a href="http://luabinaries.luaforge.net/">Lua</a>, 
		<a href="http://sourceforge.net/projects/iup/files/">IUP</a>, 
		<a href="http://sourceforge.net/projects/canvasdraw/files/">CD</a></td>
		<td> <font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/Lua51_iup30rc2_cd52.7z">download</a>] 
		</font></td>
		</tr>

		<tr><td>4. <a href="http://www.7-zip.org/">7-zip file archiver</a></td>
		<td> <font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/7z442.exe">download</a>] 
		</font></td>
		</tr>
		
		<tr><td>5. <a href="http://www.info-zip.org/">Zip file archiver</a></td>
		<td> <font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/zip232xN.zip">download</a>] 
		</font></td>
		</tr>
		
		<tr><td>6. <a href="http://www.doxygen.org/">Doxygen</a></td>
		<td> <font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/doxygen-1.6.2.7z">download</a>] 
		</font></td>
		</tr>
		
		<tr><td>7. <a href="http://www.etree.org/md5com.html">md5sum tool</a></td>
		<td> <font size="-1">
		[<a href="http://ultradefrag.sourceforge.net/devtools/md5sum-1.22.zip">download</a>] 
		</font></td>
		</tr>
		
		</tbody></table>
		
		<p>In case when the installer is provided for an appropriate tool, just install it. Otherwise 
		unpack provided archive into any directory, specified in your <span class="code">%PATH%</span> 
		environment variable. If you are in trouble, just unpack archives to <span class="code">C:\WINDOWS</span>, 
		in other words, in folder where you have Windows installed.</p>
		
		<p>If you are using the latest version of MinGW, don't be surprised when 
		<span class="code">'undefined reference to __strtod'</span> error message appears during the 
		compilation. This is because the following 
		<a href="http://sourceforge.net/tracker/index.php?func=detail&aid=1956337&group_id=2435&atid=302435">patch</a> 
		applied to MinGW is incompatible with <span class="code">msvcrt.dll</span> library which is used by the Ultra 
		Defragmenter. We hope this mistake will be resolved in future by MinGW team.</p>
		
		<font size="-1"><table border="0"><tbody><tr><td width="18pt" align="left" valign="center">
		<a href="javascript:show_section('gcc','img0')"><img id="img0" border="0" src="closed.gif" /></a></td>
		<td>Why GCC is the best choice for us?
		</td></tr></tbody></table></font>

		<div id="gcc" style="display: none; padding-left: 30pt">
		
		<p>The best C compiler for Windows I ever seen is GCC (GNU C Compiler). It produces 
		a very stable code, strongly checks sources for stadards compatibility and also has 
		a huge number of optimization keys. Another compilers have no advantages over GCC,
		therefore I strongly suggest to use it for UltraDefrag building.</p>
		
		<p>GCC can be obtained as a part of <a href="http://www.mingw.org">MinGW</a> project, 
		though it is recommended to download 
		<a href="http://ultradefrag.sourceforge.net/devtools/MinGWStudioFullSetup-2.05.exe">MinGW Developer Studio</a> 
		instead which is more compatible with UltraDefrag sources.</p>
		
		<p>At this moment there is only one important disadvantage of GCC - it cannot produce correct 
		binaries for 64-bit targets. We have tested latest binaries provided by MinGW x64 project team, 
		but the result was unsuccessful.</p>
		
		<p>Therefore we are using Microsoft C compiler (from the Windows Server 2003 DDK) 
		to produce 64-bit binaries. Another advantage of MS C compiler - it produces more compact code.</p>

		<p><font size="-1"><b>NOTE:</b> When you build dynamic libraries from the MinGW
		Developer Studio, the resulting *.a files are invalid. This is because I don't
		know how to specify linker options properly in Developer Studio's project files.</font></p>
		
		</div>
		
		<font size="-1"><table border="0"><tbody><tr><td width="18pt" align="left" valign="center">
		<a href="javascript:show_section('msvc','img1')"><img id="img1" border="0" src="closed.gif" /></a></td>
		<td>You may also use Microsoft Visual Studio 6.0 
		instead of the GCC, though this method of UltraDefrag building is much more complicated.
		</td></tr></tbody></table></font>

		<div id="msvc" style="display: none; padding-left: 30pt"><font size="-1">
		
		<p>To use Microsoft Visual Studio 6.0 you will also need to obtain a copy of ReactOS source code
		from <a href="http://www.reactos.org">ReactOS website</a> for special header files 
		used to build the driver.</p>

		<p>You will also need to download the following files:
		<a href="http://www.masm32.com/board/index.php?topic=2124.new">ntdll.lib</a> and 
		<a href="http://www.freewebs.com/four-f/index.htm">ntoskrnl.lib + hal.lib</a> 
		(included in KmdKit package). 
		Put these files to lib subdirectory of your Visual Studio installation.</p>

		<p><b>VERY IMPORTANT NOTE:</b> The winnt.h file in visual studio 6.0 
		contains an incorrect definition of the NtCurrentTeb function. Therefore replace the
		following lines:

<pre class="screen"><code>#if defined(_M_ALPHA)
#define NtCurrentTeb() ((struct _TEB *)_rdteb())
#else
struct _TEB *
NtCurrentTeb(void);
#endif</code></pre>

with:

<pre class="screen"><code>#if defined(_M_ALPHA)
#define NtCurrentTeb() ((struct _TEB *)_rdteb())
#else
struct _TEB *
__stdcall NtCurrentTeb(void);
#endif</code></pre>
		</p>

		<p>Finally, edit ultradfg.dsp file (driver project file), and ensure that the
		reactos header paths are properly set.</p>

		<p>Note that currently only i386 binaries can be produced using this way.</p>
		
		<p>As you can see, this way of compilation is much more complicated in comparison
		with MinGW compilation, therefore it may be treated as obsolete and no particularly useful.</p>
		
		</font></div>

		<h4>2. Building and installation</h4>

		<p>First of all, download source archive and unpack it somewhere. Note that currently path must not 
		contain spaces. If you have some ideas how to fix that send your suggestion to the authors, please.</p>

		<p>Configure build options by typing the following command:</p>

<pre class="screen"><strong class="userinput"><code>lua configure.lua</code></strong></pre>

		<p>Enter the paths to development tools and other options here. If you prefer to use MinGW, check also
		<span class="guimenuitem">Apply patch to MinGW</span> box and click 
		<span class="guimenuitem">OK</span> to replace some libraries included in MinGW
		(libntdll.a and libntoskrnl.a) with more adequate versions. Old libraries
		will be saved in files with an additional suffix '.orig'.</p>

		<center><img src="config.lua.png" /></center><br />
		
		<p>The screenshot above represents only the actual options which gives us the best 
		compilation result. To configure all available options, including obsolete and experimental, type:</p>
		
<pre class="screen"><strong class="userinput"><code>lua configure.lua --all</code></strong></pre>

		<p>There are four different build commands:</p>
		
		<ol type="disc">
		<li><span class="code">BUILD</span> for full-featured installer and sources package</li>
		<li><span class="code">BUILD-MICRO</span> for Micro Edition installer</li>
		<li><span class="code">BUILD-PORTABLE</span> for UltraDefrag Portable package</li>
		<li><span class="code">BUILD-MICRO-PORTABLE</span> for portable Micro Edition package</li>
		</ol>
		
		<p>To build UltraDefrag type:</p>

<pre class="screen"><strong class="userinput"><code>build</code></strong></pre>

		<p>To display list of available build options type:</p>

<pre class="screen"><strong class="userinput"><code>build --help</code></strong></pre>

		<p>If you have any questions regarding details of the build process, just look at 
		appropriate script contents. Sure you'll find an answer.</p>

		<h4>3. Development notes</h4>
		
		<p>UltraDefrag contains few modules which must be running during the Windows boot process. 
		Therefore the program utilizes a lot of undocumented Windows functions, primary exported by ntdll.dll 
		library. Please read carefully comments in the beginning of 
		<span class="code"><a href="http://ultradefrag.svn.sourceforge.net/viewvc/ultradefrag/src/dll/zenwinx/ntndk.h?view=markup">/src/dll/zenwinx/ntndk.h</a></span> 
		file before using such functions. Because they often requires something unexpected and without corresponding 
		to these rules they may simply crash your application.</p>
		
		<p>Another important note concerns GUI development. When some program uses MessageBox() 
		calls it must contain also InitCommonControls() call in the beginning of its main() 
		function. To be compatible with manifest file which defines comctl32.dll dependency for 
		Windows visual styles support. Otherwise message boxes will never appear on the screen. 
		This undocumented behavior was discovered on 32-bit XP system.</li>
		</li>
		</ol>
		
	</div>
</div>

<div style="color: black; margin-top: 20px; margin-left: 20px; margin-right: 20px;">
	<div style="position: absolute; left: 20px;"><a accesskey="p" href="credits.html">Prev</a></div>

	<div style="position: absolute; right: 20px;"><a accesskey="n" href="design_notes.html">Next</a></div>

	<div align="center"><a accesskey="h" href="index.html">Home</a></div>
</div>

<div style="color: black; margin-left: 20px; margin-right: 20px;">
	<div class="navLeft">Credits and License&nbsp;</div>

	<div class="navRight">&nbsp;Design Notes</div>

	<div class="navCenter"><a accesskey="u" href="index.html">Up</a></div>
</div>

<br />
<br />

<div class="bannerBottom" style="background-image: url(bottom-middle.png); width: 100%; height: 100px; bottom: 0px;">
	<div class="bannerBottomRight">
		<img src="bottom-right.png" style="margin: 0px;" alt="" />
	</div>
	<div class="bannerBottomLeft">
		<img src="bottom-left.png" style="margin: 0px;" alt="" />
	</div>
	<div class="bannerBottomLeft">
		<a href="http://ultradefrag.sourceforge.net/" style="position: absolute; left: 10px;">
		  <img src="udefrag124x31.gif" alt="ultradefrag.sourceforge.net" border="0" width="124" height="31" />
		</a>
		<a href="http://sourceforge.net/projects/ultradefrag" style="position: absolute; left: 134px;">
		  <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=199532&amp;type=11" alt="" border="0" height="30" width="120"  />
		</a>
	</div>
</div>

<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://apps.sourceforge.net/piwik/ultradefrag/" : "http://apps.sourceforge.net/piwik/ultradefrag/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
piwik_action_name = '';
piwik_idsite = 1;
piwik_url = pkBaseURL + "piwik.php";
piwik_log(piwik_action_name, piwik_idsite, piwik_url);
</script>
<object><noscript><p><img src="http://apps.sourceforge.net/piwik/ultradefrag/piwik.php?idsite=1" alt="piwik"/></p></noscript></object>
<!-- End Piwik Tag -->

</body>
</html>
